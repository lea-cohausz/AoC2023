Pretty ugly... worked relatively fast and I just kept the first attempt. 

Functions would probably help and lead to fewer for-statements.